<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Quiz</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Nunito', sans-serif;
    text-align: center;
    margin: 0;
    padding: 0;
    height: 100vh;
    background: linear-gradient(180deg, #fdfbfb 0%, #ebedee 100%);
    color: #333;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    overflow: hidden;
  }

  h1 {
    margin-top: 30px;
    font-size: 2.2rem;
    color: #2e4a24;
    text-shadow: 1px 1px 4px rgba(255,255,255,0.6);
  }

  #progress-container {
    width: 80%;
    max-width: 400px;
    margin: 15px auto;
    text-align: left;
  }
  #progress-text {
    font-size: 1rem;
    margin-bottom: 5px;
    font-weight: bold;
  }
  .progress-bar {
    width: 100%;
    height: 16px;
    background: #e0e0e0;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
  }
  .progress-fill {
    height: 100%;
    width: 0;
    background: linear-gradient(135deg, #43c68c, #2ca66d);
    transition: width 0.5s ease-in-out;
  }

  #quiz-area {
    background: #fff;
    padding: 20px;
    border-radius: 25px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    height: 500px;
    width: 340px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
  }

  #question-text {
    font-size: 1.1rem;
    margin-bottom: 10px;
  }

  img {
    max-width: 220px;
    max-height: 220px;
    border-radius: 15px;
    margin: 10px 0 15px;
    animation: floaty 3s ease-in-out infinite;
  }

  .btn-group {
    display: flex;
    gap: 12px;
  }

  button {
    padding: 10px 18px;
    font-size: 1rem;
    cursor: pointer;
    border: none;
    border-radius: 18px;
    color: #fff;
    font-weight: bold;
    transition: transform 0.2s;
  }
  button:hover { transform: scale(1.05); }

  #poison-btn { background: linear-gradient(135deg, #ff6b6b, #ff4e78); }
  #safe-btn { background: linear-gradient(135deg, #43c68c, #2ca66d); }
  #restart-btn {
    background: linear-gradient(135deg, #ffb347, #ffcc33);
    margin-top: 20px;
    display: none;
    padding: 12px 24px;
    font-size: 1rem;
    position: fixed;
    bottom: 10%;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10001;
  }

  #result-container {
    min-height: 60px;
    margin-top: 15px;
    font-size: 1.1rem;
    font-weight: bold;
    padding: 8px 12px;
    border-radius: 12px;
    animation: fadeIn 0.5s ease-in-out;
  }
  .correct {
    background: linear-gradient(135deg, #a8e6cf, #43c68c);
    color: #fff;
    box-shadow: 0 0 12px rgba(100,200,150,0.6);
  }
  .incorrect {
    background: linear-gradient(135deg, #ff9aa2, #ff4e78);
    color: #fff;
    box-shadow: 0 0 12px rgba(255,100,120,0.6);
    animation: shake 0.4s;
  }

  a {
    margin: 20px 0;
    padding: 10px 20px;
    background: linear-gradient(135deg, #aaa, #888);
    color: #fff;
    text-decoration: none;
    border-radius: 18px;
    font-size: 0.95rem;
    box-shadow: 0 6px 15px rgba(0,0,0,0.15);
  }
  a:hover {
    background: linear-gradient(135deg, #888, #666);
    transform: scale(1.05);
  }

  #outroVideo {
    position: fixed;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: 9997;
  }

  #outro-overlay {
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    padding: 30px 40px;
    border-radius: 25px;
    color: #fff;
    font-size: 1.3rem;
    font-weight: bold;
    text-shadow: 0 0 6px rgba(0,0,0,0.9);
    z-index: 9999;
    max-width: 85%;
    box-shadow: 0 6px 18px rgba(0,0,0,0.5);
    text-align: center;
  }

  #outro-overlay button {
    display: inline-block;
    margin: 10px 8px 0;
    padding: 10px 20px;
    border-radius: 18px;
    border: none;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    color: #fff;
  }
  #end-btn-overlay {
  background: linear-gradient(135deg, #43c68c, #2ca66d); /* 민트색 그라데이션 */
}

  #restart-btn-overlay {
    background: linear-gradient(135deg, #ffb347, #ffcc33);
  }
  #home-btn-overlay {
    background: linear-gradient(135deg, #6a9eff, #3b82f6);
  }

  @keyframes floaty {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-8px); }
    100% { transform: translateY(0px); }
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes shake {
    0% { transform: translateX(0px); }
    25% { transform: translateX(-5px); }
    50% { transform: translateX(5px); }
    75% { transform: translateX(-5px); }
    100% { transform: translateX(0px); }
  }
</style>
</head>
<body>
  <h1>이제 여러분들이 AI에게 알려줄 차례입니다!</h1>
  <div id="progress-container">
    <div id="progress-text">문제 0 / 0 | 정답률: 0%</div>
    <div class="progress-bar">
      <div class="progress-fill" id="progress-fill"></div>
    </div>
  </div>

  <div id="quiz-area">
    <p id="question-text">이 버섯은 독버섯일까요, 식용버섯일까요?</p>
    <img id="quiz-image" src="" alt="퀴즈 버섯">
    <form id="quiz-form">
      <input type="hidden" id="image-file-input" name="image_file" value="">
      <div class="btn-group" id="answer-buttons">
        <button type="submit" name="user_answer" value="독버섯" id="poison-btn">독버섯</button>
        <button type="submit" name="user_answer" value="식용버섯" id="safe-btn">식용버섯</button>
      </div>
    </form>
    <div id="result-container"></div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', async function() {
    const quizArea = document.getElementById('quiz-area');
    const quizForm = document.getElementById('quiz-form');
    const quizImage = document.getElementById('quiz-image');
    const imageFileInput = document.getElementById('image-file-input');
    const resultContainer = document.getElementById('result-container');
    const progressText = document.getElementById('progress-text');
    const progressFill = document.getElementById('progress-fill');
    const answerButtons = document.getElementById('answer-buttons');
    const restartBtn = document.getElementById('restart-btn');

    window.addEventListener("beforeunload", () => {
        sessionStorage.clear();
    });

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    async function initializeQuiz() {
        let questions = JSON.parse(sessionStorage.getItem('quizQuestions'));
        if (!questions) {
            const response = await fetch('/api/mushrooms');
            questions = await response.json();
            questions = shuffle(questions);
            sessionStorage.setItem('quizQuestions', JSON.stringify(questions));
            sessionStorage.setItem('currentQuestionIndex', '0');
            sessionStorage.setItem('correctCount', '0');
        }
        displayQuestion();
    }

    function updateProgress(index, total, correctCount) {
        const accuracy = ((correctCount / (index || 1)) * 100).toFixed(1);
        progressText.textContent = `문제 ${index} / ${total} | 정답률: ${accuracy}%`;
        progressFill.style.width = accuracy + "%";

        if (accuracy >= 70) {
            progressFill.style.background = "linear-gradient(135deg, #43c68c, #2ca66d)";
        } else if (accuracy >= 40) {
            progressFill.style.background = "linear-gradient(135deg, #ffd166, #f6ae2d)";
        } else {
            progressFill.style.background = "linear-gradient(135deg, #ff6b6b, #ff4e78)";
        }
    }

    function displayQuestion() {
        let questions = JSON.parse(sessionStorage.getItem('quizQuestions'));
        let index = parseInt(sessionStorage.getItem('currentQuestionIndex'));
        let correctCount = parseInt(sessionStorage.getItem('correctCount'));

        if (index < questions.length) {
            updateProgress(index + 1, questions.length, correctCount);
            const question = questions[index];

            quizImage.src = `/static/image/${question.file}`;
            imageFileInput.value = question.file;

            answerButtons.style.display = 'flex';
            resultContainer.innerHTML = '';
            resultContainer.className = '';
        } else {
            const accuracy = ((correctCount / questions.length) * 100).toFixed(1);
            let outroVideo = accuracy >= 60 ? "outro_v1.mp4" : "outro_v2.mp4";
            let resultMsg = accuracy >= 60 ? "🎉 통과! 마리오 세상이 안전해졌어요!" : "❌ 실패! 독버섯을 구분해내지 못했어요.";

            quizArea.style.display = "none";

            const video = document.createElement("video");
            video.id = "outroVideo";
            video.autoplay = true;
            video.controls = false;
            video.innerHTML = `<source src="/static/${outroVideo}" type="video/mp4">브라우저가 동영상을 지원하지 않습니다.`;
            document.body.appendChild(video);

            progressText.textContent = "수고하셨습니다!";
            progressFill.style.width = "100%";

            video.onended = () => {
                const overlay = document.createElement("div");
                overlay.id = "outro-overlay";
                overlay.innerHTML = `
  <h2>퀴즈 완료!</h2>
  <p>최종 정답률: <b>${accuracy}%</b><br>(${correctCount} / ${questions.length})</p>
  <p>${resultMsg}</p>
  <button id="end-btn-overlay">🎮 게임 끝내기</button>
`;

                document.body.appendChild(overlay);

               document.getElementById('end-btn-overlay').addEventListener('click', () => {
    sessionStorage.clear();
    alert("우측의 X표를 눌러 메인 화면으로 돌아가세요.");
    window.close(); // 브라우저 탭 닫기 (일부 환경에서만 동작)
});

            };
        }
    }

    quizForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(quizForm);
        const clickedButton = e.submitter;
        formData.append(clickedButton.name, clickedButton.value);

        fetch('/check', { method: 'POST', body: formData })
        .then(response => response.json())
        .then(data => {
            if (data.is_correct) {
                resultContainer.innerHTML = "✅<br>AI가 더욱 똑똑해졌어요!";
                resultContainer.className = "correct";
                let correctCount = parseInt(sessionStorage.getItem('correctCount')) + 1;
                sessionStorage.setItem('correctCount', correctCount);
            } else {
                resultContainer.innerHTML = "❌<br>AI가 혼란스러워하고 있어요";
                resultContainer.className = "incorrect";
            }

            let index = parseInt(sessionStorage.getItem('currentQuestionIndex')) + 1;
            sessionStorage.setItem('currentQuestionIndex', index);

            answerButtons.style.display = 'none';
            setTimeout(displayQuestion, 1800);
        });
    });

    initializeQuiz();
});
</script>
</body>
</html>
